<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#161616" />
    <meta name="app-version" content="1.6.0" />
    <title>Noteable</title>
    <style>
      :root {
        --bg: #161616;
        --app: #111725;
        --panel: #111827;
        --field: #0f172a;
        --muted: #94a3b8;
        --text: #e5e7eb;
        --accent: #22c55e;
        --accent-2: #60a5fa;
        --border: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        min-height: 100vh;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Inter, Arial, sans-serif;
        background: linear-gradient(90deg, var(--bg), color-mix(in srgb, var(--bg) 50%, black));
        color: var(--text);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 12px;
      }

      .app {
        width: 100%;
        max-width: 820px;
        background: var(--app);
        backdrop-filter: saturate(1.1) blur(6px);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }

      header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
      }

      header h1 {
        font-size: 16px;
        margin: 0;
        font-weight: 700;
      }

      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .pill {
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 999px;
      }

      .tab-actions {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .menu {
        position: absolute;
        right: 12px;
        top: 56px;
        background: var(--app);
        border: 1px solid var(--border);
        border-radius: 8px;
        min-width: 160px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        z-index: 100;
      }

      .menu button {
        width: 100%;
        padding: 8px 12px;
        background: none;
        border: none;
        color: var(--text);
        text-align: left;
        cursor: pointer;
      }

      .menu button:hover {
        background: rgba(255, 255, 255, 0.06);
      }

      .menu hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 6px 0;
      }

      .hidden {
        display: none;
      }

      /* Tabs */
      .tabs {
        display: flex;
        flex-wrap: wrap; /* allow tabs to wrap onto multiple rows */
        gap: 8px;
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        overflow: visible; /* remove horizontal scrollbar */
      }

      /* Individual tabs */
      .tab {
        background: transparent;
        border: 1px solid var(--border);
        padding: 8px 10px;
        border-radius: 10px;
        color: var(--muted);
        cursor: pointer;
        white-space: nowrap; /* keep tab text on a single line */
        flex-shrink: 0; /* prevent tabs from shrinking too small */
      }

      .tab.active {
        background: linear-gradient(90deg, var(--accent-2), color-mix(in srgb, var(--accent-2) 75%, white));
        color: var(--app);
        border-color: transparent;
        font-weight: 700;
      }

      .tab small {
        display: block;
        font-size: 11px;
        color: inherit;
        opacity: 0.9;
      }

      main {
        display: block;
        padding: 12px;
      }

      .note-area {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* Field layout: label row with small icon buttons, then input/textarea with copy button to the right */
      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .label-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .field-label {
        font-size: 13px;
        color: var(--muted);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .label-actions {
        display: flex;
        gap: 6px;
        margin-left: auto;
      }

      .icon-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--muted);
        padding: 4px 6px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
      }

      .icon-btn:hover {
        border-color: var(--accent-2);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
      }

      .input-row {
        display: flex;
        gap: 8px;
        align-items: flex-start;
      }

      input[type="text"],
      textarea {
        background: var(--field);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        outline: none;
        width: 91%;
      }

      textarea {
        min-height: 80px;
        resize: vertical;
      }

      .copy-btn {
        appearance: none;
        border: none;
        background: var(--accent);
        color: var(--app);
        padding: 10px 15px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
      }

      .copy-btn:hover {
        background: color-mix(in srgb, var(--accent) 75%, white);
      }

      .btn {
        appearance: none;
        border: none;
        background: var(--accent-2);
        color: var(--app);
        padding: 8px 12px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
      }

      .ghost {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
      }

      .ghost:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: var(--accent-2);
      }

      .small {
        padding: 6px 8px;
        border-radius: 8px;
        font-weight: 700;
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
      }

      @media (max-width: 220px) {
        .tab {
          padding: 8px 10px;
          font-size: 13px;
        }

        header {
          padding: 12px;
        }

        .app {
          border-radius: 12px;
        }

        .label-actions {
          gap: 4px;
        }

        .icon-btn {
          padding: 6px;
        }

        .copy-btn {
          padding: 6px;
        }

        .input-row {
          flex-direction: column;
          align-items: stretch;
        }
      }

      .tabs::-webkit-scrollbar {
        height: 8px;
      }

      .tabs::-webkit-scrollbar-thumb {
        background: var(--field);
        border-radius: 8px;
      }

      input[type="file"] {
        display: none;
      }

      .draggable-label {
        cursor: grab;
      }

      .draggable-label:active {
        cursor: grabbing;
      }
      /* Container for buttons */
      .button-row {
        display: flex;
        flex-direction: column; /* stack main buttons + JSON buttons */
        gap: 6px;
        margin-top: 12px;
        align-items: center;
      }

      /* Sub-groups */
      .main-buttons,
      .json-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: nowrap; /* keep buttons together in each group */
        justify-content: center;
      }

      /* JSON buttons wrap only if needed at ultra narrow widths */
      @media (max-width: 150px) {
        .main-buttons {
          overflow-x: auto; /* allow scrolling if main buttons don't fit */
        }
        .json-buttons {
          flex-wrap: wrap; /* Export + Import stack if needed */
        }

        /* Reduce button size */
        .btn,
        .ghost,
        .copy-btn,
        .icon-btn {
          padding: 4px 6px;
          font-size: 10px;
        }

        header h1 {
          font-size: 14px;
        }
      }

      footer {
        padding: 12px;
        border-top: 1px solid var(--border);
        font-size: 12px;
        color: var(--muted);
        display: flex;
        flex-direction: row; /* default: row on wide screens */
        justify-content: space-between;
        gap: 4px;
        flex-wrap: wrap;
      }

      /* --- Dialog base --- */
      dialog {
        border: none;
        border-radius: 14px;
        padding: 16px 18px;
        background: var(--app);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        width: 90%;
        max-width: 800px;
        width: calc(100% - 24px);
      }

      /* Dark backdrop */
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(2px);
      }

      /* Headings */
      dialog h3 {
        margin: 0 0 12px;
        font-size: 1.1rem;
      }

      /* Labels & inputs */
      dialog label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.85rem;
        margin-bottom: 12px;
      }

      dialog input[type="color"] {
        height: 36px;
        padding: 2px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: transparent;
      }

      /* Buttons row */
      .dialog-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 14px;
      }

      dialog button {
        border-radius: 8px;
        padding: 6px 12px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        cursor: pointer;
      }

      dialog button:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      /* Links in About */
      dialog a {
        color: var(--accent);
        text-decoration: none;
      }

      dialog a:hover {
        text-decoration: underline;
      }

      dialog[open] {
        animation: dialogFadeIn 0.15s ease-out;
      }

      @keyframes dialogFadeIn {
        from {
          opacity: 0;
          transform: translateY(6px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }

      /* Force vertical stacking for narrow windows */
      @media (max-width: 300px) {
        footer {
          flex-direction: column; /* stack hints vertically */
          align-items: flex-start; /* left-align text */
          gap: 2px;
        }
      }
    </style>
  </head>

  <body>
    <div class="app" role="application" aria-label="Notebook with tabs">
      <header>
        <h1>Noteable</h1>
        <div class="controls">
          <!--<span class="pill">Tabs • Copy per field</span>-->
          <button id="addTabBtn" class="btn small" title="Add tab">
            New tab
          </button>
          <div class="tab-actions">
            <button id="menuBtn" class="icon-btn" aria-label="Menu">
              <!-- Hamburger SVG -->
              <svg
                viewBox="0 0 24 24"
                width="18"
                height="18"
                fill="currentColor"
              >
                <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z" />
              </svg>
            </button>
          </div>

          <div id="menuDropdown" class="menu hidden">
            <button id="exportBtn" title="Export notebook to JSON">
              Export JSON
            </button>
            <button id="importBtn" title="Import notebook from JSON">
              Import JSON
            </button>
            <hr />
            <button id="settingsBtn">Settings</button>
            <button id="aboutBtn">About</button>
          </div>
        </div>
      </header>

      <nav class="tabs" id="tabs" aria-label="Tabs"></nav>

      <main>
        <div class="note-area" id="noteArea" aria-live="polite"></div>

        <div class="button-row">
          <div class="main-buttons">
            <button id="addLabelBtn" class="ghost small">Add text field</button>
            <button id="addTextareaBtn" class="ghost small">
              Add note field
            </button>
            <button id="clearTabBtn" class="ghost small">Clear tab</button>
          </div>
          <div class="json-buttons">
            <!--<button
              id="exportBtn"
              class="ghost small"
              title="Export notebook to JSON"
            >
              Export (JSON)
            </button>
            <button
              id="importBtn"
              class="ghost small"
              title="Import notebook from JSON"
            >
              Import (JSON)
            </button>-->
            <input
              id="importFile"
              type="file"
              accept="application/json"
              aria-hidden="true"
            />
          </div>
        </div>
      </main>

      <footer>
        <span class="hint">
          Data is stored locally in your browser.
        </span>
        <span id="app-version"></span>
        <!--<span class="hint">
          Optimized for narrow windows-->
      </footer>

      <dialog id="settingsDialog">
        <h3>Settings</h3>
        <p><strong>Appearance</strong></p>

        <label>
          Background
          <input type="color" data-css-var="--bg" />
        </label>

        <label>
          App background
          <input type="color" data-css-var="--app" />
        </label>

        <label>
          Panel
          <input type="color" data-css-var="--panel" />
        </label>

        <label>
          Field background
          <input type="color" data-css-var="--field" />
        </label>

        <label>
          Muted text
          <input type="color" data-css-var="--muted" />
        </label>

        <label>
          Text
          <input type="color" data-css-var="--text" />
        </label>

        <label>
          Accent
          <input type="color" data-css-var="--accent" />
        </label>

        <label>
          Accent 2
          <input type="color" data-css-var="--accent-2" />
        </label>

        <label>
          Border
          <input type="color" data-css-var="--border" />
        </label>

        <div class="dialog-actions">
          <button id="resetColorsBtn">Reset to default</button>
          <button onclick="settingsDialog.close()">Close</button>
        </div>
      </dialog>

      <dialog id="aboutDialog">
        <h3>About</h3>
        <p><strong>Noteable by Lys</strong></p>
        <p>
          Manage and quickly copy notes, sort and organize notes in multiple tabs, with customizeable fields and color themes • Optimized for narrow windows
        </p>
        <p>
          Right-click tabs to rename, double-click to delete 
        </p>
        <span id="aboutVersion"></span>
        <p>
          <a href="https://github.com/lyseste" target="_blank"> GitHub </a>
        </p>
        <p>© 2026 Joakim Virik</p>
        <button onclick="aboutDialog.close()">Close</button>
      </dialog>
    </div>

    <script>
      const STORAGE_KEY = "notebook.v1";

      const $ = (s) => document.querySelector(s);
      const tabsEl = $("#tabs");
      const noteArea = $("#noteArea");
      const addTabBtn = $("#addTabBtn");
      const addLabelBtn = $("#addLabelBtn");
      const addTextareaBtn = $("#addTextareaBtn");
      const clearTabBtn = $("#clearTabBtn");
      const exportBtn = $("#exportBtn");
      const importBtn = $("#importBtn");
      const importFile = $("#importFile");
      const searchInput = document.createElement("input");

      const DEFAULT_COLORS = {
        "--bg": "#0b0e14",
        "--app": "#111725",
        "--panel": "#111827",
        "--field": "#0f172a",
        "--muted": "#94a3b8",
        "--text": "#e5e7eb",
        "--accent": "#22c55e",
        "--accent-2": "#60a5fa",
        "--border": "#1f2937",
      };

      searchInput.type = "text";
      searchInput.placeholder = "Search fields in this tab...";
      searchInput.style.marginBottom = "8px";
      searchInput.style.width = "100%";
      searchInput.addEventListener("input", renderNoteArea);
      noteArea.parentNode.insertBefore(searchInput, noteArea);

      const menuBtn = document.getElementById("menuBtn");
      const menuDropdown = document.getElementById("menuDropdown");

      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        menuDropdown.classList.toggle("hidden");
      });

      document.addEventListener("click", () => {
        menuDropdown.classList.add("hidden");
      });

      let state = { tabs: [], activeTabId: null };
      const uid = (prefix = "id") =>
        prefix + "_" + Math.random().toString(36).slice(2, 9);

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          state = JSON.parse(raw);
        } catch (e) {
          console.error("Failed load", e);
        }
      }
      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.error("Failed save", e);
        }
      }

      function ensureDefault() {
        if (!state.tabs || state.tabs.length === 0) {
          const t = {
            id: uid("tab"),
            name: "Tab 1",
            fields: [
              { id: uid("f"), type: "label", label: "Title", value: "" },
            ],
          };
          state.tabs = [t];
          state.activeTabId = t.id;
          saveState();
        }
      }

      // --- TAB RENDERING WITH DRAG ---
      function renderTabs() {
        tabsEl.innerHTML = "";
        state.tabs.forEach((t) => {
          const btn = document.createElement("button");
          btn.className = "tab" + (t.id === state.activeTabId ? " active" : "");
          btn.type = "button";
          btn.title = t.name;
          btn.textContent = t.name;

          // Click to switch
          btn.addEventListener("click", () => {
            state.activeTabId = t.id;
            saveState();
            render();
          });

          // Rename on contextmenu
          btn.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            const newName = prompt("Rename tab", t.name);
            if (newName === null) return;
            const trimmed = newName.trim();
            if (trimmed.length === 0) return alert("Name cannot be empty");
            t.name = trimmed;
            saveState();
            render();
          });

          // Delete on dblclick
          btn.addEventListener("dblclick", () => {
            if (!confirm('Delete tab "' + t.name + '"?')) return;
            state.tabs = state.tabs.filter((x) => x.id !== t.id);
            if (state.tabs.length === 0) {
              state.activeTabId = null;
              ensureDefault();
            }
            if (state.activeTabId === t.id)
              state.activeTabId = state.tabs[0].id;
            saveState();
            render();
          });

          // Drag start
          btn.draggable = true;
          btn.addEventListener("dragstart", (e) => {
            btn.classList.add("dragging");
            e.dataTransfer.setData("text/plain", t.id);
          });
          btn.addEventListener("dragend", () =>
            btn.classList.remove("dragging")
          );

          tabsEl.appendChild(btn);
        });

        // Tab drag over
        tabsEl.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = tabsEl.querySelector(".tab.dragging");
          const afterEl = getDragAfterElement(tabsEl, e.clientX, false);
          if (!afterEl) tabsEl.appendChild(dragging);
          else tabsEl.insertBefore(dragging, afterEl);
          updateTabOrder();
        });
      }

      // --- Automatically resize textareas when switching between tabs
      function autoResize(el) {
        el.style.height = "auto"; // Reset first
        el.style.height = el.scrollHeight + 2 + "px"; // Adjust to fit content
      }

      // --- FIELD RENDERING WITH SEARCH AND DRAG HANDLE ---
      function renderNoteArea() {
        noteArea.innerHTML = "";
        const tab = state.tabs.find((t) => t.id === state.activeTabId);
        if (!tab) {
          noteArea.textContent = "No tab selected";
          return;
        }

        const term = searchInput.value.toLowerCase();

        tab.fields
          .filter(
            (f) =>
              f.label.toLowerCase().includes(term) ||
              f.value.toLowerCase().includes(term)
          )
          .forEach((field) => {
            const container = document.createElement("div");
            container.className = "field";

            // --- Label row ---
            const labelRow = document.createElement("div");
            labelRow.className = "label-row";

            const label = document.createElement("h4");
            label.className = "field-label draggable-label";
            label.textContent =
              field.label || (field.type === "textarea" ? "Note" : "Text");
            label.draggable = true;

            // Drag start
            label.addEventListener("dragstart", (e) => {
              container.classList.add("dragging");
            });

            // Drag end
            label.addEventListener("dragend", (e) => {
              container.classList.remove("dragging");
              updateFieldOrder(); // Update state after drop
            });

            labelRow.appendChild(label);

            // --- Edit/Delete buttons ---
            const labelActions = document.createElement("div");
            labelActions.className = "label-actions";

            // Edit button (inline SVG)
            const renameBtn = document.createElement("button");
            renameBtn.className = "icon-btn";
            renameBtn.title = "Rename field";
            renameBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 17.25V21h3.75l11-11.02-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
      </svg>`;
            renameBtn.addEventListener("click", () => {
              const name = prompt("Rename field label", field.label || "");
              if (name !== null) {
                field.label = name.trim();
                saveState();
                renderNoteArea();
              }
            });

            // Delete button (inline SVG)
            const delBtn = document.createElement("button");
            delBtn.className = "icon-btn";
            delBtn.title = "Delete field";
            delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
        <path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
      </svg>`;
            delBtn.addEventListener("click", () => {
              if (!confirm("Delete this field?")) return;
              tab.fields = tab.fields.filter((f) => f.id !== field.id);
              saveState();
              renderNoteArea();
            });

            labelActions.appendChild(renameBtn);
            labelActions.appendChild(delBtn);
            labelRow.appendChild(labelActions);

            // --- Input row + copy button ---
            const inputRow = document.createElement("div");
            inputRow.className = "input-row";
            let inputEl;
            if (field.type === "label") {
              inputEl = document.createElement("input");
              inputEl.type = "text";
              inputEl.value = field.value || "";
              inputEl.addEventListener("input", (e) => {
                field.value = e.target.value;
                saveState();
              });
            } else {
              inputEl = document.createElement("textarea");
              inputEl.value = field.value || "";
              inputEl.addEventListener("input", (e) => {
                field.value = e.target.value;
                autoResize(e.target); // Resize when typing
                saveState();
              });
              autoResize(inputEl); // Resize when switching tab
            }
            inputRow.appendChild(inputEl);

            const copyBtn = document.createElement("button");
            copyBtn.className = "copy-btn";
            copyBtn.type = "button";
            copyBtn.textContent = "Copy";
            copyBtn.addEventListener("click", () => {
              navigator.clipboard
                .writeText(field.value || "")
                .then(() => flashNotice("Copied!"));
            });
            inputRow.appendChild(copyBtn);

            container.appendChild(labelRow);
            container.appendChild(inputRow);
            noteArea.appendChild(container);
          });

        if (tab.fields.length === 0) {
          const p = document.createElement("p");
          p.className = "hint";
          p.textContent = "This tab is empty — use the buttons to add fields.";
          noteArea.appendChild(p);
        }

        // --- Drag-and-drop for fields ---
        noteArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = noteArea.querySelector(".field.dragging");
          if (!dragging) return;
          const afterEl = getDragAfterElement(noteArea, e.clientY, true);
          if (!afterEl) noteArea.appendChild(dragging);
          else noteArea.insertBefore(dragging, afterEl);
        });
        if (tab.fields.length === 0) {
          const p = document.createElement("p");
          p.className = "hint";
          p.textContent = "This tab is empty — use the buttons to add fields.";
          noteArea.appendChild(p);
        }

        requestAnimationFrame(() => {
          noteArea.querySelectorAll("textarea").forEach(autoResize);
        });
      }

      // --- HELPER FOR DRAG POSITION ---
      function getDragAfterElement(container, pos, vertical = true) {
        const draggableElements = [
          ...container.querySelectorAll(
            vertical ? ".field:not(.dragging)" : "button.tab:not(.dragging)"
          ),
        ];
        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = vertical
              ? pos - (box.top + box.height / 2)
              : pos - (box.left + box.width / 2);
            if (offset < 0 && offset > closest.offset)
              return { offset, element: child };
            else return closest;
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      // --- UPDATE FIELD ORDER AFTER DRAG ---
      function updateFieldOrder() {
        const tab = state.tabs.find((t) => t.id === state.activeTabId);
        if (!tab) return;
        const newFields = [];
        noteArea.querySelectorAll(".field").forEach((container) => {
          const labelText = container.querySelector(".field-label").textContent;
          const inputEl = container.querySelector("input,textarea");
          const value = inputEl.value;
          const type =
            inputEl.tagName.toLowerCase() === "textarea" ? "textarea" : "label";
          newFields.push({ id: uid("f"), label: labelText, type, value });
        });
        tab.fields = newFields;
        saveState();
      }

      // --- UPDATE TAB ORDER AFTER DRAG ---
      function updateTabOrder() {
        const newTabs = [];
        tabsEl.querySelectorAll("button.tab").forEach((btn) => {
          const t = state.tabs.find(
            (x) => x.id === btn.title || x.name === btn.textContent
          );
          if (t) newTabs.push(t);
        });
        state.tabs = newTabs;
        saveState();
      }

      // --- Copy notification ---
      let noticeTimeout = 0;
      function flashNotice(msg) {
        clearTimeout(noticeTimeout);
        let el = document.getElementById("__notice");
        if (!el) {
          el = document.createElement("div");
          el.id = "__notice";
          el.style.position = "fixed";
          el.style.bottom = "18px";
          el.style.left = "50%";
          el.style.transform = "translateX(-50%)";
          el.style.background = "rgba(8,12,16,.9)";
          el.style.color = "#d1fae5";
          el.style.padding = "10px 14px";
          el.style.borderRadius = "12px";
          el.style.boxShadow = "0 6px 18px rgba(2,6,23,.6)";
          el.style.zIndex = "9999";
          document.body.appendChild(el);
        }
        el.textContent = msg;
        el.style.opacity = "1";
        noticeTimeout = setTimeout(() => {
          el.style.opacity = "0";
        }, 1500);
      }

      // --- BUTTONS ---
      addTabBtn.addEventListener("click", () => {
        const name = prompt("Name for new tab", "New tab");
        if (name === null) return;
        const tab = {
          id: uid("tab"),
          name: name.trim() || "New tab",
          fields: [{ id: uid("f"), type: "label", label: "Title", value: "" }],
        };
        state.tabs.push(tab);
        state.activeTabId = tab.id;
        saveState();
        render();
      });
      addLabelBtn.addEventListener("click", () => {
        const tab = state.tabs.find((t) => t.id === state.activeTabId);
        if (!tab) return;
        const lbl = prompt("Label for new text field", "Text");
        tab.fields.push({
          id: uid("f"),
          type: "label",
          label: lbl === null ? "Text" : lbl.trim() || "Text",
          value: "",
        });
        saveState();
        renderNoteArea();
      });
      addTextareaBtn.addEventListener("click", () => {
        const tab = state.tabs.find((t) => t.id === state.activeTabId);
        if (!tab) return;
        const lbl = prompt("Label for new note field", "Note");
        tab.fields.push({
          id: uid("f"),
          type: "textarea",
          label: lbl === null ? "Note" : lbl.trim() || "Note",
          value: "",
        });
        saveState();
        renderNoteArea();
      });
      clearTabBtn.addEventListener("click", () => {
        const tab = state.tabs.find((t) => t.id === state.activeTabId);
        if (!tab) return;
        if (!confirm('Clear all fields in tab "' + tab.name + '"?')) return;
        tab.fields.forEach((f) => (f.value = ""));
        saveState();
        renderNoteArea();
      });

      exportBtn.addEventListener("click", () => {
        try {
          const dataStr = JSON.stringify(state, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `notebook-backup-${new Date()
            .toISOString()
            .slice(0, 19)
            .replace(/[:T]/g, "-")}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          flashNotice("Exported to file");
        } catch (e) {
          alert("Could not export: " + e.message);
        }
      });
      importBtn.addEventListener("click", () => {
        importFile.click();
      });
      importFile.addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) {
          handleImportFile(f);
          importFile.value = "";
        }
      });

      function handleImportFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            if (!imported || !Array.isArray(imported.tabs))
              throw new Error("Invalid format");
            const replace = confirm(
              "Replace existing notes with file contents? (OK = Replace, Cancel = Merge)"
            );
            if (replace) {
              state.tabs = imported.tabs.map((t) => ({
                id: uid("tab"),
                name: t.name || "Imported tab",
                fields: Array.isArray(t.fields)
                  ? t.fields.map((f) => ({
                      id: uid("f"),
                      type: f.type === "textarea" ? "textarea" : "label",
                      label: f.label || "Text",
                      value: f.value || "",
                    }))
                  : [],
              }));
              state.activeTabId = state.tabs.length ? state.tabs[0].id : null;
              saveState();
              render();
              flashNotice("Import completed — replaced existing");
            } else {
              imported.tabs.forEach((t) => {
                const tab = {
                  id: uid("tab"),
                  name: t.name || "Imported tab",
                  fields: Array.isArray(t.fields)
                    ? t.fields.map((f) => ({
                        id: uid("f"),
                        type: f.type === "textarea" ? "textarea" : "label",
                        label: f.label || "Text",
                        value: f.value || "",
                      }))
                    : [],
                };
                state.tabs.push(tab);
              });
              if (!state.activeTabId && state.tabs.length)
                state.activeTabId = state.tabs[0].id;
              saveState();
              render();
              flashNotice("Import completed — merged");
            }
          } catch (err) {
            alert("Import error: " + err.message);
          }
        };
        reader.onerror = () => {
          alert("Could not read file");
        };
        reader.readAsText(file);
      }

      // --- SETTINGS DIALOG ---
      const settingsDialog = document.getElementById("settingsDialog");

      document.getElementById("settingsBtn").addEventListener("click", () => {
        settingsDialog.showModal();
        openSettings();
      });

      function openSettings() {
        const styles = getComputedStyle(document.documentElement);

        settingsDialog
          .querySelectorAll("input[data-css-var]")
          .forEach((input) => {
            const cssVar = input.dataset.cssVar;
            const value = styles.getPropertyValue(cssVar).trim();

            // Ensure valid hex for <input type="color">
            input.value = value || DEFAULT_COLORS[cssVar];
          });

        settingsDialog.showModal();
      }

      // --- ABOUT DIALOG ---
      const aboutDialog = document.getElementById("aboutDialog");
      const version =
        document.querySelector('meta[name="app-version"]')?.content ||
        "unknown";

      document.getElementById(
        "aboutVersion"
      ).textContent = `Version ${version}`;

      document.getElementById("aboutBtn").addEventListener("click", () => {
        aboutDialog.showModal();
      });

      document.querySelectorAll("dialog").forEach((dialog) => {
        dialog.addEventListener("click", (e) => {
          const rect = dialog.getBoundingClientRect();
          const clickedOutside =
            e.clientX < rect.left ||
            e.clientX > rect.right ||
            e.clientY < rect.top ||
            e.clientY > rect.bottom;

          if (clickedOutside) {
            dialog.close();
          }
        });
      });

      // --- COLOR THEME MANAGER ---
      settingsDialog.addEventListener("input", (e) => {
        const input = e.target;
        const cssVar = input.dataset.cssVar;
        if (!cssVar) return;

        document.documentElement.style.setProperty(cssVar, input.value);

        saveThemeToStorage();
      });

      function saveThemeToStorage() {
        const theme = {};
        for (const key in DEFAULT_COLORS) {
          theme[key] = getComputedStyle(document.documentElement)
            .getPropertyValue(key)
            .trim();
        }
        localStorage.setItem("noteable.theme", JSON.stringify(theme));
      }

      function loadThemeFromStorage() {
        const raw = localStorage.getItem("noteable.theme");
        if (!raw) return;

        try {
          const theme = JSON.parse(raw);
          for (const key in theme) {
            document.documentElement.style.setProperty(key, theme[key]);
          }
        } catch {}
      }

      loadThemeFromStorage();

      document
        .getElementById("resetColorsBtn")
        .addEventListener("click", () => {
          for (const key in DEFAULT_COLORS) {
            document.documentElement.style.setProperty(
              key,
              DEFAULT_COLORS[key]
            );
          }

          localStorage.removeItem("noteable.theme");

          // Update inputs visually
          openSettings();
        });

      // --- RENDER ---
      function render() {
        ensureDefault();
        renderTabs();
        renderNoteArea();
      }
      loadState();
      ensureDefault();
      render();
      window.addEventListener("beforeunload", saveState);

      document.addEventListener("DOMContentLoaded", () => {
        const metaVersion = document
          .querySelector('meta[name="app-version"]')
          ?.getAttribute("content");

        const versionTarget = document.getElementById("app-version");
        if (versionTarget && metaVersion) {
          versionTarget.textContent = `Version ${metaVersion}`;
        }
      });

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("./sw.js?ver=2")
          .then((reg) => console.log("Service Worker registered:", reg))
          .catch((err) => console.error("SW registration failed:", err));
      }
    </script>
  </body>
</html>
